on:
  workflow_dispatch:

jobs:
  build_and_release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Set up JDK 25
        uses: actions/setup-java@v5
        with:
          distribution: zulu
          java-version: '25'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          cache-read-only: true

      - name: Verify Keystore
        run: |
          if [ -z "${{ secrets.SIGNING_KEY_STORE_BASE64 }}" ]; then
            echo "ERROR: SIGNING_KEY_STORE_BASE64 secret is missing"
            exit 1
          fi

      - name: Setup Signing Keys
        run: |
          mkdir -p keystore
          echo "${{ secrets.SIGNING_KEY_STORE_BASE64 }}" | base64 --decode > keystore/carlyu.jks
          cat > keystore.properties <<EOF
          storeFile=keystore/carlyu.jks
          keyAlias=${{ secrets.SIGNING_KEY_ALIAS }}
          keyPassword=${{ secrets.SIGNING_KEY_PASSWORD }}
          storePassword=${{ secrets.SIGNING_STORE_PASSWORD }}
          EOF

      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      - name: Build Stable Release APKs
        env:
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: ./gradlew assembleOnlineStableRelease assembleOfflineStableRelease -PAPP_ID=com.android.packageinstaller

      - name: Find and Rename APKs with APK Version and Date
        run: |
          PROJECT_NAME="InstallerX-Revived"
          DATE=$(date +%Y%m%d)
          VERSION=$(./gradlew -q printVersionName | tail -n1)

          mkdir -p artifacts
          for FLAVOR in online offline; do
            APK_DIR="app/build/outputs/apk/${FLAVOR}Stable/release"
            ORIGINAL_APK=$(find "$APK_DIR" -maxdepth 1 -type f -name "*.apk" | head -n 1)

            if [ -z "$ORIGINAL_APK" ]; then
              echo "ERROR: APK not found in $APK_DIR"
              ls -R app/build/outputs/apk
              exit 1
            fi

            NEW_APK="artifacts/${PROJECT_NAME}-${VERSION}-${FLAVOR}-${DATE}.apk"
            cp "$ORIGINAL_APK" "$NEW_APK"
          done

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: "InstallerX Revived stable ${{ github.ref_name }}"
          tag_name: ${{ github.ref_name }}
          body: "Stable release built on ${{ github.run_id }}"
          files: artifacts/*.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
