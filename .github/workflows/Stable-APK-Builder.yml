name: Stable APK Builder

on:
  workflow_dispatch:

jobs:
  build_and_release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Set up JDK 25
        uses: actions/setup-java@v5
        with:
          distribution: zulu
          java-version: '25'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          cache-read-only: true

      - name: Verify Keystore
        run: |
          if [ -z "${{ secrets.SIGNING_KEY_STORE_BASE64 }}" ]; then
            echo "ERROR: SIGNING_KEY_STORE_BASE64 secret is missing"
            exit 1
          fi

      - name: Setup Signing Keys
        run: |
          mkdir -p keystore
          echo "${{ secrets.SIGNING_KEY_STORE_BASE64 }}" | base64 --decode > keystore/carlyu.jks
          cat <<EOF > keystore.properties
          storeFile=keystore/carlyu.jks
          keyAlias=${{ secrets.SIGNING_KEY_ALIAS }}
          keyPassword=${{ secrets.SIGNING_KEY_PASSWORD }}
          storePassword=${{ secrets.SIGNING_STORE_PASSWORD }}
          EOF

      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      - name: Build Online Stable Release APK
        env:
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: ./gradlew assembleOnlineStableRelease -PAPP_ID=com.android.packageinstaller

      - name: Find and Rename Online APK with Version and Date
        id: rename_apk
        run: |
          PROJECT_NAME="InstallerX"
          DATE=$(date +%Y%m%d)
          VERSION=$(./gradlew -q printVersionName | tail -n1)

          mkdir -p artifacts

          APK_DIR="app/build/outputs/apk/onlineStable/release"
          ORIGINAL_APK=$(find "$APK_DIR" -maxdepth 1 -type f -name "*.apk" | head -n 1)

          if [ -z "$ORIGINAL_APK" ]; then
            echo "ERROR: APK not found in $APK_DIR"
            ls -R app/build/outputs/apk
            exit 1
          fi

          NEW_APK="artifacts/${PROJECT_NAME}_online_v${VERSION}_${DATE}.apk"
          cp "$ORIGINAL_APK" "$NEW_APK"

          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "DATE=$DATE" >> $GITHUB_ENV
          echo "NEW_APK_PATH=$NEW_APK" >> $GITHUB_ENV

      - name: Create Latest Alpha Pre-Release
        uses: softprops/action-gh-release@v2
        with:
          name: "${{ env.VERSION }}-${{ env.DATE }}-${{ github.run_number }} Alpha"
          tag_name: "alpha-v${{ env.VERSION }}-${{ github.run_number }}"
          draft: false
          prerelease: true
          files: ${{ env.NEW_APK_PATH }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
